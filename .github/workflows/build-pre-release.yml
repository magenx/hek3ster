name: Build Go App for Pre-Release

on:
  release:
    types: [published]

env:
  PRELELEASE_TYPE: ${{ vars.PRERELEASE_TYPE }}

concurrency:
  group: build
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build-pre-release:
    if: "${{ github.event.release.prerelease == true }}"
    name: Build Go Binary - ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
          - os: darwin
            arch: arm64
            runner: macos-latest
            goos: darwin
            goarch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: '1.25.0'
          cache: true

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GH_TOKEN: ${{ secrets.HEK3STER_TOKEN }}
        run: |
          # Run all test
          CGO_ENABLED=1 go test -v -race -coverprofile=coverage.out ./...
          
          # Fetch the version from the GitHub release tag
          VERSION="${{ github.event.release.tag_name }}"
          
          # Dynamically set the binary name based on OS and architecture
          BINARY_NAME="hek3ster-${{ matrix.os }}-${{ matrix.arch }}"
          
          echo "Building ${BINARY_NAME} with version ${VERSION}"
          
          # Build the Go binary with version information embedded via -ldflags
          CGO_ENABLED=0 go build -ldflags "-X github.com/magenx/hek3ster/pkg/version.Version=${VERSION} -s -w" -o "${BINARY_NAME}" ./cmd/hek3ster
          
          # Check if the binary was successfully built
          if [ ! -f "${BINARY_NAME}" ]; then
            echo "Error: Build failed. Binary not found!"
            exit 1
          fi
          
          # Ensure the binary is executable
          chmod +x "${BINARY_NAME}"
          
          # Create checksums
          sha256sum ${BINARY_NAME} >> checksums.txt
          
          # Upload Release Artifact
          #echo "Uploading $BINARY_NAME with version ${VERSION}"
          #gh release upload ${{ github.event.release.tag_name }} "${BINARY_NAME}#${BINARY_NAME}"
          #gh release upload ${{ github.event.release.tag_name }} "${BINARY_NAME}_sha256sum.txt#${BINARY_NAME}_sha256sum"

      - name: Attach Release Artifact
        id: attach-release-artifact
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          token: ${{ secrets.HEK3STER_TOKEN }}
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            hek3ster-*
            checksums.txt
          append_body: true
          body: |
            ## Installation Instructions

            ### Linux (amd64)
            ```bash
            curl -fsSLO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hek3ster-linux-amd64
            chmod +x hek3ster-linux-amd64
            sudo mv hek3ster-linux-amd64 /usr/local/bin/hek3ster
            ```
            
            ### Linux (arm64)
            ```bash
            curl -fsSLO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hek3ster-linux-arm64
            chmod +x hek3ster-linux-arm64
            sudo mv hek3ster-linux-arm64 /usr/local/bin/hek3ster
            ```
            
            ### macOS (arm64)
            ```bash
            curl -fsSLO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hek3ster-darwin-arm64
            chmod +x hek3ster-darwin-arm64
            sudo mv hek3ster-darwin-arm64 /usr/local/bin/hek3ster
            ```
            
            ## Verify checksums
            Download `checksums.txt` and verify your binary:
            ```bash
            sha256sum -c checksums.txt --ignore-missing
            ```

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: hek3ster-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            hek3ster-${{ matrix.os }}-${{ matrix.arch }}
            ${BINARY_NAME}_sha256sum.txt
          retention-days: 7
